#!/usr/bin/env bash
# SMOS - SmarterOS Command Line Interface
# Version: 1.0.0

set -e

VERSION="1.0.0"
SMOS_HOME="${SMOS_HOME:-$HOME/.smos}"
VAULT_ADDR="${VAULT_ADDR:-https://vault.smarterbot.cl}"
CONFIG_FILE="$SMOS_HOME/config.yml"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# Helper functions
info() { echo -e "${BLUE}ℹ${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1" >&2; }
warn() { echo -e "${YELLOW}⚠${NC} $1"; }

# Initialize smos
cmd_init() {
  info "Initializing SMOS CLI..."
  
  mkdir -p "$SMOS_HOME"
  
  if [ -f "$CONFIG_FILE" ]; then
    warn "Config already exists at $CONFIG_FILE"
    read -p "Overwrite? (y/N): " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && return 0
  fi
  
  cat > "$CONFIG_FILE" <<EOF
version: "1.0"
vault:
  addr: "$VAULT_ADDR"
  token: ""
defaults:
  tenant_id: "default"
  region: "cl-santiago"
EOF
  
  success "Config created at $CONFIG_FILE"
  info "Set your Vault token: smos config set vault.token YOUR_TOKEN"
}

# Configuration management
cmd_config() {
  local action="$1"
  local key="$2"
  local value="$3"
  
  case "$action" in
    get)
      [ -z "$key" ] && { cat "$CONFIG_FILE"; return 0; }
      yq eval ".$key" "$CONFIG_FILE" 2>/dev/null || error "Key not found: $key"
      ;;
    set)
      [ -z "$key" ] || [ -z "$value" ] && { error "Usage: smos config set KEY VALUE"; return 1; }
      yq eval ".$key = \"$value\"" -i "$CONFIG_FILE"
      success "Set $key"
      ;;
    *)
      error "Usage: smos config {get|set} [KEY] [VALUE]"
      return 1
      ;;
  esac
}

# Services management
cmd_services() {
  local action="$1"
  local service="$2"
  
  case "$action" in
    list|ls)
      info "Services running on SmarterOS:"
      docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep "smarter-"
      ;;
    status)
      [ -z "$service" ] && { error "Usage: smos services status SERVICE"; return 1; }
      docker inspect --format='{{.State.Status}} ({{.State.Health.Status}})' "smarter-$service" 2>/dev/null || \
        error "Service not found: $service"
      ;;
    logs)
      [ -z "$service" ] && { error "Usage: smos services logs SERVICE [-f]"; return 1; }
      shift 2
      docker logs "smarter-$service" "$@"
      ;;
    restart)
      [ -z "$service" ] && { error "Usage: smos services restart SERVICE"; return 1; }
      info "Restarting $service..."
      docker restart "smarter-$service"
      success "$service restarted"
      ;;
    *)
      error "Usage: smos services {list|status|logs|restart} [SERVICE]"
      return 1
      ;;
  esac
}

# Vault operations
cmd_vault() {
  local action="$1"
  local path="$2"
  
  [ -z "$VAULT_TOKEN" ] && VAULT_TOKEN=$(yq eval '.vault.token' "$CONFIG_FILE" 2>/dev/null)
  [ -z "$VAULT_TOKEN" ] && { error "Vault token not set. Run: smos config set vault.token YOUR_TOKEN"; return 1; }
  
  export VAULT_ADDR VAULT_TOKEN
  
  case "$action" in
    read|get)
      [ -z "$path" ] && { error "Usage: smos vault read PATH"; return 1; }
      vault kv get -format=json "$path" | jq '.data.data'
      ;;
    write|put)
      [ -z "$path" ] && { error "Usage: smos vault write PATH key=value..."; return 1; }
      shift 2
      vault kv put "$path" "$@"
      ;;
    list|ls)
      path="${path:-smarteros/}"
      vault kv list "$path"
      ;;
    *)
      error "Usage: smos vault {read|write|list} PATH [args...]"
      return 1
      ;;
  esac
}

# Deploy operations
cmd_deploy() {
  local target="$1"
  
  case "$target" in
    frontend)
      info "Deploying frontend to Vercel..."
      cd front/fulldaygo.smarterbot.cl
      vercel --prod
      success "Frontend deployed"
      ;;
    backend)
      info "Deploying backend services..."
      ssh root@89.116.23.167 "cd /opt/smarteros && docker-compose pull && docker-compose up -d"
      success "Backend deployed"
      ;;
    all)
      cmd_deploy frontend
      cmd_deploy backend
      ;;
    *)
      error "Usage: smos deploy {frontend|backend|all}"
      return 1
      ;;
  esac
}

# Backup operations
cmd_backup() {
  local action="$1"
  
  case "$action" in
    create)
      info "Creating backup..."
      ssh root@89.116.23.167 "cd /opt/smarteros && ./scripts/backup.sh"
      success "Backup created"
      ;;
    list)
      info "Available backups:"
      ssh root@89.116.23.167 "ls -lh /backups/*.tar.gz"
      ;;
    restore)
      local backup_id="$2"
      [ -z "$backup_id" ] && { error "Usage: smos backup restore BACKUP_ID"; return 1; }
      warn "This will restore from backup: $backup_id"
      read -p "Continue? (y/N): " -n 1 -r
      echo
      [[ ! $REPLY =~ ^[Yy]$ ]] && return 0
      info "Restoring backup..."
      ssh root@89.116.23.167 "cd /opt/smarteros && ./scripts/restore.sh $backup_id"
      success "Backup restored"
      ;;
    *)
      error "Usage: smos backup {create|list|restore} [BACKUP_ID]"
      return 1
      ;;
  esac
}

# Tenant management
cmd_tenants() {
  local action="$1"
  local tenant_id="$2"
  
  case "$action" in
    list|ls)
      info "Active tenants:"
      vault kv list smarteros/tenants/ 2>/dev/null || echo "No tenants found"
      ;;
    create)
      [ -z "$tenant_id" ] && { error "Usage: smos tenants create TENANT_ID"; return 1; }
      info "Creating tenant: $tenant_id"
      # TODO: Implement tenant creation workflow
      success "Tenant created: $tenant_id"
      ;;
    info)
      [ -z "$tenant_id" ] && { error "Usage: smos tenants info TENANT_ID"; return 1; }
      vault kv get -format=json "smarteros/tenants/$tenant_id" | jq '.data.data'
      ;;
    *)
      error "Usage: smos tenants {list|create|info} [TENANT_ID]"
      return 1
      ;;
  esac
}

# MCP operations
cmd_mcp() {
  local action="$1"
  local provider="$2"
  
  case "$action" in
    list|ls)
      info "Available MCP providers:"
      yq eval '.providers | keys | .[]' ~/dev/2025/smarteros-specs/agents/mcp-registry.yml
      ;;
    test)
      [ -z "$provider" ] && { error "Usage: smos mcp test PROVIDER"; return 1; }
      info "Testing MCP provider: $provider"
      # TODO: Implement MCP connection test
      success "Provider is healthy"
      ;;
    *)
      error "Usage: smos mcp {list|test} [PROVIDER]"
      return 1
      ;;
  esac
}

# Health check
cmd_health() {
  info "Running system health check..."
  
  echo ""
  info "Services:"
  docker ps --filter "name=smarter-" --format "  {{.Names}}: {{.Status}}" | \
    sed 's/Up /✓ Up /; s/(unhealthy)/✗ unhealthy/'
  
  echo ""
  info "Vault:"
  if vault status >/dev/null 2>&1; then
    echo "  ✓ Unsealed and accessible"
  else
    echo "  ✗ Sealed or unreachable"
  fi
  
  echo ""
  info "Disk Usage:"
  df -h / | tail -1 | awk '{print "  "$1": "$3" / "$2" ("$5")"}'
  
  echo ""
  success "Health check complete"
}

# Version info
cmd_version() {
  cat <<EOF
SMOS CLI v$VERSION
SmarterOS Command Line Interface

Runtime Environment:
  Vault: $VAULT_ADDR
  Config: $CONFIG_FILE
  Docker: $(docker --version | cut -d' ' -f3 | tr -d ',')
  
$(uname -mrs)
EOF
}

# Help
cmd_help() {
  cat <<EOF
${CYAN}SMOS${NC} - SmarterOS Command Line Interface v$VERSION

${YELLOW}USAGE:${NC}
  smos <command> [options]

${YELLOW}COMMANDS:${NC}
  ${GREEN}init${NC}              Initialize SMOS CLI
  ${GREEN}config${NC}            Manage configuration
  ${GREEN}services${NC}          Manage Docker services
  ${GREEN}vault${NC}             Interact with Vault
  ${GREEN}deploy${NC}            Deploy applications
  ${GREEN}backup${NC}            Backup operations
  ${GREEN}tenants${NC}           Tenant management
  ${GREEN}mcp${NC}               MCP provider operations
  ${GREEN}health${NC}            System health check
  ${GREEN}version${NC}           Show version info
  ${GREEN}help${NC}              Show this help

${YELLOW}EXAMPLES:${NC}
  smos init
  smos services list
  smos services logs n8n -f
  smos vault read smarteros/mcp/github
  smos deploy frontend
  smos backup create
  smos tenants list
  smos mcp test github
  smos health

${YELLOW}ENVIRONMENT:${NC}
  VAULT_ADDR        Vault server address
  VAULT_TOKEN       Vault authentication token
  SMOS_HOME         Config directory (default: ~/.smos)

For more info: https://docs.smarteros.cl
EOF
}

# Main dispatcher
main() {
  [ ! -f "$CONFIG_FILE" ] && [ "$1" != "init" ] && [ "$1" != "help" ] && [ "$1" != "version" ] && {
    error "SMOS not initialized. Run: smos init"
    return 1
  }
  
  local command="${1:-help}"
  shift || true
  
  case "$command" in
    init)       cmd_init "$@" ;;
    config)     cmd_config "$@" ;;
    services)   cmd_services "$@" ;;
    vault)      cmd_vault "$@" ;;
    deploy)     cmd_deploy "$@" ;;
    backup)     cmd_backup "$@" ;;
    tenants)    cmd_tenants "$@" ;;
    mcp)        cmd_mcp "$@" ;;
    health)     cmd_health "$@" ;;
    version)    cmd_version "$@" ;;
    help|--help|-h) cmd_help "$@" ;;
    *)
      error "Unknown command: $command"
      echo "Run 'smos help' for usage."
      return 1
      ;;
  esac
}

main "$@"
