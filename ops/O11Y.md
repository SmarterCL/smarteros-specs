# SMARTEROS — OBSERVABILITY SYSTEM

---

## 1. Métricas Clave (Golden Signals)

### Latency
- API Gateway P50: < 200ms
- API Gateway P95: < 500ms
- API Gateway P99: < 1000ms

### Traffic
- Requests/sec: Monitor threshold
- Bytes/sec: Network saturation

### Errors
- HTTP 5xx rate: < 0.1%
- Timeout rate: < 0.05%

### Saturation
- CPU: < 70%
- Memory: < 80%
- Disk: < 85%
- DB connections: < 80% pool

---

## 2. Heartbeats

### Services
```bash
# API Gateway
GET /health
Expected: 200 OK {"status": "healthy"}

# Odoo
GET /web/health
Expected: 200 OK

# Chatwoot
GET /health
Expected: 200 OK {"status": "ok"}

# PostgreSQL
SELECT 1;
Expected: 1 row

# Vault
vault status
Expected: Unsealed
```

---

## 3. SLOs (Service Level Objectives)

| Service | Availability | Latency P95 | Error Budget |
|---------|--------------|-------------|--------------|
| API Gateway | 99.9% | 500ms | 43min/month |
| Odoo ERP | 99.5% | 2000ms | 3.6h/month |
| Chatwoot | 99.5% | 1000ms | 3.6h/month |
| PostgreSQL | 99.95% | 100ms | 21min/month |

---

## 4. Alertas

### Critical (SEV-1)
```yaml
alerts:
  - name: APIDown
    condition: health_check_failed > 3
    action: page_oncall
    
  - name: DatabaseDown
    condition: pg_up == 0
    action: page_oncall + escalate_cto
    
  - name: HighErrorRate
    condition: error_rate > 5%
    action: page_oncall
```

### Warning (SEV-2)
```yaml
  - name: HighLatency
    condition: p95_latency > 1000ms
    action: notify_devops
    
  - name: DiskSpaceLow
    condition: disk_usage > 85%
    action: notify_ops
```

---

## 5. Dashboards (Metabase/Grafana)

### System Overview
- Requests/min
- Error rate
- Latency P50/P95/P99
- Active tenants
- CPU/Memory per service

### Tenant View
```sql
SELECT 
  tenant_id,
  COUNT(*) as requests_today,
  AVG(latency_ms) as avg_latency,
  SUM(CASE WHEN status >= 500 THEN 1 ELSE 0 END) as errors
FROM api_logs
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY tenant_id;
```

---

## 6. Logs

### Structured Logging
```json
{
  "timestamp": "2025-11-23T10:00:00Z",
  "level": "ERROR",
  "service": "api-gateway",
  "tenant_id": "76953480-3",
  "request_id": "req_abc123",
  "message": "Database connection timeout",
  "stack_trace": "...",
  "metadata": {
    "endpoint": "/odoo/products",
    "method": "GET",
    "user_id": "user_xyz"
  }
}
```

### Log Retention
- ERROR/CRITICAL: 90 days
- INFO: 30 days
- DEBUG: 7 days

---

## 7. Tracing

### Distributed Tracing
```
Request: GET /odoo/products
├─ API Gateway (10ms)
├─ Auth Check (50ms)
├─ Vault Secret Fetch (30ms)
├─ Odoo XML-RPC Call (500ms)
│  └─ PostgreSQL Query (200ms)
└─ Response Serialization (10ms)
Total: 600ms
```

---

**Owner:** DevOps + SRE  
**Review:** Continuo
