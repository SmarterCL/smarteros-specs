version: '3.8'
services:
  traefik:
    image: traefik:v2.11
    command:
    - --entrypoints.web.address=:80
    - --entrypoints.websecure.address=:443
    - --providers.docker=true
    - --providers.docker.exposedbydefault=false
    - --api.insecure=true
    - --certificatesresolvers.letsencrypt.acme.httpchallenge=true
    - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
    - --certificatesresolvers.letsencrypt.acme.email=smarterbotcl@gmail.com
    - --certificatesresolvers.letsencrypt.acme.storage=/letsencrypt/acme.json
    ports:
    - 80:80
    - 443:443
    - 8080:8080
    volumes:
    - /var/run/docker.sock:/var/run/docker.sock:ro
    - ./letsencrypt:/letsencrypt
    networks:
    - traefik-network
  dokploy:
    image: dokploy/dokploy:latest
    container_name: dokploy
    environment:
    - DATABASE_URL=postgresql://postgres:password@root-postgres-1:5432/dokploy
    - REDIS_URL=redis://redis:6379
    ports:
    - 3000:3000
    networks:
    - traefik-network
    labels:
    - traefik.enable=true
    - traefik.http.routers.dokploy.rule=Host(`dokploy.smarterbot.cl`)
    - traefik.http.routers.dokploy.entrypoints=websecure
    - traefik.http.routers.dokploy.tls.certresolver=letsencrypt
    - traefik.http.services.dokploy.loadbalancer.server.port=3000
    depends_on:
    - postgres
    - redis
  postgres:
    image: postgres:16
    environment:
    - POSTGRES_PASSWORD=password
    - POSTGRES_DB=dokploy
    volumes:
    - postgres_data:/var/lib/postgresql/data
    networks:
    - traefik-network
  redis:
    image: redis:7
    networks:
    - traefik-network
networks:
  traefik-network:
    driver: bridge
volumes:
  postgres_data: {}
