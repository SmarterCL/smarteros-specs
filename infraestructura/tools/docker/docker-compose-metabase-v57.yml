version: '3.9'

services:
  metabase:
    image: metabase/metabase:v0.57.3
    container_name: smarteros-metabase-v57
    restart: always
    ports:
      - "3001:3000"
    environment:
      MB_DB_TYPE: h2
      MB_DB_FILE: /metabase-data/metabase.db
      MB_SITE_NAME: "SmarterOS KPI"
      MB_SITE_URL: "https://kpi.smarterbot.cl"
      # Dark mode como predeterminado
      MB_APPEARANCE_THEME: dark
      # Multi-tenant settings
      MB_ENABLE_EMBEDDING: "true"
      MB_EMBEDDING_SECRET_KEY: ${MB_EMBEDDING_SECRET_KEY:-changeme}
      # Security
      MB_PASSWORD_COMPLEXITY: strong
      MB_PASSWORD_LENGTH: 10
      # Performance
      JAVA_OPTS: "-Xmx2g -Xms512m"
    volumes:
      - metabase-data:/metabase-data
    networks:
      - smarteros-network
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.metabase.rule=Host(`kpi.smarterbot.cl`)"
      - "traefik.http.routers.metabase.entrypoints=websecure"
      - "traefik.http.routers.metabase.tls.certresolver=myresolver"
      - "traefik.http.services.metabase.loadbalancer.server.port=3000"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

volumes:
  metabase-data:
    driver: local

networks:
  smarteros-network:
    external: true
